# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Auto-patch CVEs (Python + SBOM + Attest)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 8 * * 1" # Mondays 08:00 UTC

permissions:
  contents: write
  pull-requests: write
  id-token: write # needed for keyless signing (cosign)

jobs:
  autopatch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # -----------------------------------------------------------
      # FIXED: Install project deps FIRST, then CLI deps.
      # -----------------------------------------------------------
      - name: Install autopatch deps
        run: |
          python -m pip install --upgrade pip
          echo "Installing project requirements first..."
          if [ -f "requirements.txt" ]; then pip install -r requirements.txt; fi
          echo "Installing autopatch CLI helper deps..."
          pip install packaging tabulate

      # -- Create plan and capture exit code (10 means updates exist) --
      - name: Create plan.csv
        id: plan
        shell: bash
        run: |
          set +e
          python -m autopatch.cli plan -r requirements.txt -o plan.csv
          CODE=$?
          echo "exit_code=$CODE" >> "$GITHUB_OUTPUT"
          echo "Plan exit code: $CODE"
          exit 0

      - name: Show plan
        run: |
          echo "Plan (first 20 lines):"
          head -n 20 plan.csv || true

      # ---- SBOM generation ----
      - name: Set up Node (for cdxgen)
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install cdxgen
        run: npm install -g @cyclonedx/cdxgen

      - name: Generate SBOM (CycloneDX)
        run: |
          mkdir -p reports
          cdxgen -t python -o sbom.cdx.json .

      # ---- OSV scan ----
      - name: Install OSV-Scanner
        run: |
          curl -sSfL https://raw.githubusercontent.com/google/osv-scanner/refs/heads/main/install.sh \
            | sh -s -- -b /usr/local/bin
            echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Scan SBOM with OSV
        run: |
          osv-scanner --sbom sbom.cdx.json --format json --output reports/osv-report.json

      # ---- Sign + verify SBOM ----
      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign SBOM (keyless)
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          cosign sign-blob --yes --keyless \
            --output-signature sbom.sig \
            --output-certificate sbom.cert \
            sbom.cdx.json

      - name: Verify SBOM signature
        run: |
          cosign verify-blob --certificate sbom.cert --signature sbom.sig sbom.cdx.json

      # ---- Reproducibility test ----
      - name: Reproducibility (pip freeze twice)
        shell: bash
        run: |
          python -m venv .r1
          source .r1/bin/activate
          pip install -r requirements.txt
          pip freeze > reports/freeze1.txt
          deactivate || true

          python -m venv .r2
          source .r2/bin/activate
          pip install -r requirements.txt
          pip freeze > reports/freeze2.txt
          deactivate || true

          diff -u reports/freeze1.txt reports/reproducibility.diff || true

      # ---- Metrics ----
      - name: Build metrics summary
        shell: bash
        run: |
          python - <<'PY'
          import csv, json, os
          fixable = 0
          total = 0
          if os.path.exists("plan.csv"):
              with open("plan.csv", newline="", encoding="utf-8") as f:
                  for row in csv.DictReader(f):
                      total += 1
                      if row.get("fix_version"):
                          fixable += 1
          metrics = {"packages_scanned": total, "packages_with_fixes": fixable}
          os.makedirs("reports", exist_ok=True)
          with open("reports/metrics.json","w",encoding="utf-8") as f:
              json.dump(metrics, f, indent=2)
          print("Metrics:", metrics)
          PY

      # ---- Apply fixes & create PR ----
      - name: Apply plan to requirements.txt
        if: ${{ steps.plan.outputs.exit_code == '10' }}
        run: |
          python -m autopatch.cli apply -r requirements.txt -p plan.csv

      - name: Create pull request
        if: ${{ steps.plan.outputs.exit_code == '10' }}
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "autopatch: bump vulnerable dependencies (OSV)"
          title: "Autopatch: bump vulnerable dependencies"
          body: |
            This PR was generated automatically by the autopatch workflow.

            **Evidence**
            - SBOM: `sbom.cdx.json` (signed: `sbom.sig`, `sbom.cert`)
            - OSV scan: `reports/osv-report.json`
            - Reproducibility diff: `reports/reproducibility.diff`
            - Plan: `plan.csv`
            - Metrics: `reports/metrics.json`

            **Properties:** Transparency, Validity, Separation.
          branch: autopatch/osv-fixes
          add-paths: |
            requirements.txt
            plan.csv
            sbom.cdx.json
            sbom.sig
            sbom.cert
            reports/osv-report.json
            reports/reproducibility.diff
            reports/metrics.json

      # ---- Upload artifacts ----
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: autopatch-reports
          path: |
            plan.csv
            sbom.cdx.json
            sbom.sig
            sbom.cert
            reports/
